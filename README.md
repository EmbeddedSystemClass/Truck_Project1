Truck_Project1_notes.txt<br />
<br />
Truck_Project1 is an automotive SCADA system which uses a Xilinx Spartan-3E to <br />
monitor real-time data, a PIC24FJ128GB110 to handle a keypad and route message<br />
traffic, a ATMEGA328P to drive a t6963 LCD screen, and a TS-7200/7800 to do<br />
I/O (turning on and off lights and reading switches).<br />
<br />
![System Diagram](System_Diagram.JPG)<br />
<br />
the STM32F100RB (STM32) will route message traffic to and from the FPGA, the <br />
TS-7200 and the LCD screen.<br />
<br />
The menuing of the LCD screen and can display optional real time info like engine speed,<br />
engine temp, oil pressure etc coming directly from the FPGA.<br />
<br />
There will also be a task to read the ADC's which measure temp sensors and the oil pressure<br />
(among other things like the photodiode behind the windshield).<br />
The FPGA has 2 serial ports (transmit only) that send rpm & mph data to a couple of off-the-<br />
shelf 4 digit LED's that will be on the dashboard. The FPGA also sends the rpm & mph data to<br />
the PIC via the serial port.<br />
<br />
Other telemetry data can be added later like distributor timing to use for spark advance.<br />
<br />
directories:<br />
STM32 - directory created by STMCubeMX used to generate the FreeRTOS tasks, queues and periferals<br />
<br />
AVR_t6963 - ATMEGA328p source and support files (uses avrdude)<br />
<br />
thread_io - source for the TS-7200/7800 cards (from Technologic Systems)<br />
<br />
thread_io/cs_client - source for init_db & list_db (programs used to manage odata.dat db) and other<br />
	source files<br />
<br />
thread_io/cs_client/EpServerClient - Visual Studio project for tcp client that runs on laptop in<br />
	vehicle as car PC and supplementary server that runs on desktop in garage to talk to laptop<br />
	over WiFi.<br />
<br />
thread_io/test_tcp - other stuff used in project: <br />
	server.c is an ARM compiled file that downloads the new sched after the TS-7200 exits with a <br />
	special return code which instructs the bash file to run 'server' to talk to a program called<br />
	'SendFile' which runs from the laptop to send the new sched file.<br />
	show_params.c and make_params.c are used to show and make the param.conf config file which<br />
	the sched program keeps track of config data.<br />
	test_ioports and test_inports are used to test the io daughter cards <br />
<br />
Truck_App1 - source for the FPGA (Xilinx Spartan-3E) in VHDL<br />
<br />
The STM32 directory has the source files used by TrueStudio to compile the hex file to download<br />
to the STM32F100RB. I use the ST32 ST-LINK utility which programs the STM32 over a USB port.<br />
The STM32 program was generated by using STM32CubeMX. There are only certain sections of the code<br />
which the user can modify. Anything else gets deleted when you pull the project into CubeMX.<br />
The project was generated to use FreeRTOS.<br />
<br />
The thread_io directory has files used to compile an embedded linux program that uses<br />
the POSIX pthread library to handle serial io and tcp/ip traffic and drive a io card that<br />
plugs into the TS-7XXX PC-104 bus. I bought the cards used on ebay. They are made by<br />
Tri-M Engineering. Each card has 20 inputs and 20 outputs. The outputs are small 5A relays<br />
onboard the card. The cards can be set to access different memory/io addresses so up<br />
to 4 can be stacked on each other. I've tried just about every free RTOS out there and<br />
no-one seems to have the ports to work on the TS-7200 which use the ARM920T processor with<br />
the EP9301 chipset. I like the uCOS-II Jean J. Labrosse of Micrium, Weston, FL and he has<br />
the port files for the ARM processor but I wasn't inclined to take a year-long self-course<br />
on ARM assembly language, linux internals and the ARM architecture, although I did 'hack'<br />
through it for a while. So using the POSIX pthreads are a pretty good alternative and you<br />
can learn more about pthreads from 'Pthreads Programming' by Dick Buttlar from O'Reilly.<br />
<br />
The Truck_App1 directory has all the files for compiling (if you want to call it that)<br />
a Spartan-3E FPGA from Xilinx. The files ending in .vhd are the VHDL programming language<br />
and I used a free copy of ISE from Xilinx. Actually, I tried to download it from the <br />
Xilinx website recently and its not exactly free since now you have to have a verifiable<br />
company and phone no. so I'm using a free copy I downloaded a couple years ago. The<br />
particular board running this is called an XC3S500E which only has the Spartan-3E chip,<br />
the clock and the pinout connectors for no less that 200 io pins. These can be purchased<br />
on ebay for about $35USD. All the other development boards have all the buttons, LEDs,<br />
DB connectors and USB ports which I didn't need. The only problem with the io connectors<br />
with these is that they are not the standard 1mm pitch that fits nicely into most<br />
perfboards which is what I'm using since I'm not into making my own printed circuit<br />
boards. If you can find a copy of ISE from Xilinx, it also comes with a simulator called<br />
ISim which lets you see how your VHDL program works and is really useful for testing<br />
and debugging the FPGA. The other alternative to Xilinx would be Altera which is probably<br />
geared more towards the hobbiest, I would think, but I'm too far down the rabbit hole<br />
now. If you want a copy of ISE, email me at hwswhacker1256@gmail.com and I'll see if<br />
I can get the file to you via ftp or something.<br />
<br />
A 4x4 keypad is attached to the STM32 so when a key is pressed, one of the <br />
following bytes is decoded:<br />
<br />
0xE0 - '#'<br />
0xE1 - '*'<br />
0xE2 - '0'<br />
0xE3 - '1'<br />
0xE4 - '2'<br />
0xE5 - '3'<br />
0xE6 - '4'<br />
0xE7 - '5'<br />
0xE8 - '6'<br />
0xE9 - '7'<br />
0xEA - '8'<br />
0xEB - '9'<br />
0xEC - 'A'<br />
0xED - 'B'<br />
0xEE - 'C'<br />
0xEF - 'D'<br />
<br />
keypad layout - since the six reassignable keys are on the outside (bottom and left) it makes<br />
sense to use these as special function keys.<br />
<br />
1 2 3 A<br />
4 5 6 B<br />
7 8 9 C<br />
* 0 # D<br />
<br />
dec		hex		char<br />
35		23		#<br />
42		2a		*<br />
48		30		0<br />
49		31		1<br />
50		32		2<br />
51		33		3<br />
52		34		4<br />
53		35		5<br />
54		36		6<br />
55		37		7<br />
56		38		8<br />
57		39		9<br />
65		41		A<br />
66		42		B<br />
67		43		C<br />
68		44		D<br />
<br />
				<br />
The TS-7200 uses comm1 to talk to the STM32 and Comm2 as an optional monitor (see printString2<br />
in thread_io program). The TS-7200 uses the ethernet connector as a TCP/IP server so a linux<br />
box running the client program (/dev/thread_io/ncurses) can be hooked up and and the <br />
client can log on and off at anytime.<br />
<br />
FPGA connections:<br />
<br />
1) 2 inputs for the mph & rpm and alternately, another rpm for the optional<br />
		missing tooth wheel.<br />
2) a tone-generator output which goes to a speaker.<br />
3) an output which breaks the circuit to the fuel pump.<br />
4) other optional IO for future expansion.<br />
<br />
The inputs to the FPGA should have 5v clamping diodes which go to a 5v-3v3 converter.<br />
<br />
AVR Makefile options to save eeprom across flash reprogramming:<br />
"make set_eeprom_save_fuse" to set fuses so eeprom is saved when reprogramming<br />
"make clear_eeprom_save_fuse" to set fuses so eeprom gets erased everytime<br />
<br />
(10/13/17)<br />
TS-7800:<br />
Has 3 UARTS, faster CPU & better OS. Memory access is diff for DIO/LCD & PC104.<br />
No built-in SPI like the TS-7200 but very little docs on the Marvell processor. <br />
(would be nice to have interrupt routine that handles the SPI which the pins could be<br />
on the DIO. Since the TS-7800 is in a remote box we have to use serial anyway).<br />
<br />
(10/25/17)<br />
added 2 branches: TS-7200 & TS-7800 but made changes in master so the Makefile in<br />
thread_io can be changed to compile for either one. (search for "-DTS-7800")<br />
also need to change the init_client(HOSTn) in demo_menus2.c and client.c in ncurses<br />
according to the defines in client.h: <br />
<br />
(4/29/18)<br />
did away with all the menuing stuff in AVR which was a gigantic menuing system which was<br />
supposed to be configurable. Long story short, the esos RTOS can't send mail messages<br />
from regular functions, even when called from and esos task, nor can you call any<br />
ESOS_TASK macros so now the menu choices and screen display will just have to be<br />
hard-coded in for whatever is needed.<br />
<br />
(9/4/18)<br />
realized if I'm measuring the pulse of 1 plug wire, then I am getting a pulse for <br />
every 2 revolutions of the crankshaft. So since I couldn't figure out how to set<br />
the RPM_DVND and RPM_CLOCK_COUNT in lib/Common.vhd, I just doubled the result value<br />
in sensor.vhd returned from the averaging algoritm. <br />
<br />
Don't use the functon pointer array in the thread_io, just have dedicated threads<br />
and have the serial port one with the highest priority.<br />
<br />
Get all the ssh's to use keygen instead of passwords<br />
<br />
got the following strange wtf error:<br />
	A clock IOB / clock component pair have been found that are not placed at an optimal clock IOB /<br />
   clock site pair. The clock component <reset_IBUF_BUFG> is placed at site <BUFGMUX_X2Y0>. <br />
   The IO component <reset> is placed at site <IPAD119>.  This will not allow the use of the<br />
   fast path between the IO and the Clock buffer. This is normally an ERROR but the <br />
   CLOCK_DEDICATED_ROUTE constraint was applied on COMP.PIN <reset.PAD> allowing your design<br />
   to continue. This constraint disables all clock placer rules related to the specified COMP.PIN. <br />
   The use of this override is highly discouraged as it may lead to very poor timing results. <br />
   It is recommended that this error condition be corrected in the design.<br />
then added the line:<br />
NET "reset" CLOCK_DEDICATED_ROUTE = FALSE;<br />
in the ucf file to turn it to a warning after trying for 3 days to fix it. Some kind of <br />
timing problem...<br />
<br />
when setting VHDL variables in the declaration statement like:<br />
	"signal fubar: std_logic_vector(7 downto 0):= "00000000";"<br />
and then trying to set the variable again in the reset section of the FSM, it will<br />
use the value set in the reset section in the simulator, but when running the program<br />
on the chip, it will use the value set in the declaration. Spent about 3-4 hours<br />
on this one night.<br />
<br />
can't call ESOS_TASK_WAIT_TICKS from within mail recipient?<br />
<br />
note: don't do any assignment statements before ESOS_TASK_BEGIN()<br />
it causes strange side-effects<br />
<br />
**************** todo ****************<br />
<br />
added fuel pump shutoff output for FPGA which shuts off fuel pump when rpms go to zero<br />
this must be overridden to start (relay in series with relay controlled by io card)<br />
<br />
also added rev limit feature which opens relay in series with io controlled relay for<br />
ignition but might just want to have it set off an alarm - too much gas to carb to shut<br />
off ignition possibly could wash out cylinders ?<br />
<br />
Need another database which has list of on-off times for each IO port. Have a field in<br />
the O_DATA database which points to a on-off database (or text file).<br />
In task2 when we check for a change in the inputs, check for a time-up in a list of<br />
which active time-up array and then check the time of day to see if that port should<br />
be turned on or off.<br />
(9-4-18) -this works for types 0-3<br />
<br />
sched needs a config file so it knows which dat files were used last instead<br />
of just idata & odata which are loaded by default (see odometer.txt)<br />
<br />
When E-Stop button is pushed and if lights are one, the lights will stay on for a preset<br />
amount of time. <br />
<br />
Start making backups of client exe's when uploading new sched's to iobox on vehicle because<br />
if any of the cmd_types get changed in the system and the new client gets started it might<br />
not work with the old sched because it is sending different cmd_types back and forth.<br />
If this happens, then the only way to fix it is to have a linux desktop in the vehicle to<br />
use to ftp into the iobox and upload the new exe. <br />
<br />
1) get dual boot linux/windows desktop with keyboard and mouse and hook up the VGA port to<br />
	the in-dash monitor.<br />
2) with a null-modem RS-232 cable, connect to the iobox to the linux desktop.<br />
3) put the sched on the linux drive and boot up in linux.<br />
4) install a router between the iobox and the desktop<br />
5) ftp into the iobox and load the new sched to the root of the iobox.<br />
6) reboot the desktop into windows and with the new client, make sure everything works.<br />
<br />
**************** nice to have's: ****************<br />
<br />
use 2 extra pins from FPGA to 25 watt stereo amp using pwm2.vhd to play tunes<br />
<br />
FPGA reads from missing tooth wheel for the crank position and calculates the amount<br />
of necessary spark advance to control the distributor<br />
<br />
Use the ts-bat3 battery backup on the stack.<br />
<br />
TS-7800 has (2) SATA connectors for SSD drives. <br />
<br />
One of the TS-7200's have the PC104 pins going thru the bottom - we could put the bat3<br />
on top of it and the other IO boards underneath which might be safer.<br />
<br />
Find out how to get TS-7200 to use the pthreadlib in its lib dir so we don't have to<br />
send it over as a static.<br />
<br />
GPS and accel modules on FPGA (serial?)<br />
<br />
cadmium sulfide photodetector under windshield for measuing light level to <br />
dim display to rpm/mph LED's and LCD screen automatically.<br />
<br />
have a 100 or so byte section at beginning of dat files (just after the id tag) reserved<br />
for comments that can be edited and viewed.<br />
<br />
Use ESP8266 for remote wireless (bluetooth) control from Android phone (remote start<br />
- alarm disable - door poppers)<br />
<br />
SEN-12756 Sparkfun 3-Axis Accelerometer MMA8452<br />
SEN-11931 Sparkfun Dig. Temp Sensor TMP102<br />
<br />
